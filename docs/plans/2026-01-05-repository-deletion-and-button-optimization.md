# 仓库删除同步技能清理和按钮优化设计

## 设计日期
2026-01-05

## 概述

本设计包含两个功能改进：
1. 删除技能仓库时，自动删除该仓库的未安装技能记录并清理缓存目录
2. 优化仓库卡片按钮，合并"扫描"和"刷新缓存"按钮，移除"清理缓存"按钮

## 需求分析

### 需求 1：删除仓库时同步删除技能

**当前问题**：
- 删除仓库时，只删除 `repositories` 表中的记录
- `skills` 表中与该仓库关联的技能没有被删除
- 技能市场中仍会显示已删除仓库的技能
- 缓存目录没有被清理，占用磁盘空间

**期望行为**：
- 删除仓库时，自动删除该仓库的**未安装**技能记录
- 保留已安装的技能（用户已安装的技能不会丢失）
- 自动删除该仓库的缓存目录，释放磁盘空间

### 需求 2：优化仓库卡片按钮

**当前问题**：
- 仓库卡片有三个按钮：扫描、刷新缓存、清理缓存
- 扫描和刷新缓存功能重复，用户困惑何时使用哪个
- 清理缓存按钮使用场景少，价值不高

**期望行为**：
- 合并"扫描"和"刷新缓存"按钮为一个智能按钮
- 未缓存时显示"一键扫描"（4个字）
- 已缓存时显示"重新扫描"（4个字）
- 移除"清理缓存"按钮

## 架构设计

### 整体改动范围

1. **后端（Rust）**：
   - 修改 `src-tauri/src/commands/mod.rs` 中的 `delete_repository` 命令
   - 可能需要在 `src-tauri/src/services/database.rs` 中添加辅助方法

2. **前端（React）**：
   - 修改 `src/components/RepositoriesPage.tsx` 的按钮渲染逻辑
   - 移除清理缓存相关的 UI 和状态管理
   - 更新 `useDeleteRepository` hook，添加技能列表刷新

### 核心原则

- 删除操作在后端作为单一事务处理，确保原子性
- 前端只负责触发删除并刷新 UI
- 保持现有 API 接口不变，只增强 `delete_repository` 的内部逻辑

## 实现方案

### 方案选择：后端统一处理删除逻辑

**优点**：
- 逻辑集中在后端，原子性操作更安全
- 前端代码改动最小
- 易于添加事务处理，确保数据一致性
- 如果删除失败，可以回滚所有操作
- 性能更好（一次 API 调用）

**缺点**：
- 需要修改 Rust 代码

### 后端删除逻辑详细设计

**修改 `delete_repository` 命令的执行流程**：

1. **查询仓库信息**：
   - 通过 `repo_id` 获取仓库的完整信息（特别是 `url` 和 `cache_path`）
   - 如果仓库不存在，返回错误

2. **删除未安装的技能**：
   - 查询 `skills` 表，条件：`repository_url = repo.url AND installed = 0`
   - 批量删除这些技能记录
   - 使用数据库事务确保原子性

3. **清理缓存目录**：
   - 如果 `cache_path` 存在且目录实际存在
   - 使用 `std::fs::remove_dir_all()` 删除整个目录
   - 如果删除失败（例如权限问题），记录警告但不中断流程

4. **删除仓库记录**：
   - 从 `repositories` 表中删除该仓库
   - 与步骤 2 在同一事务中执行

**错误处理策略**：
- 使用数据库事务确保步骤 2 和 4 的原子性
- 缓存目录删除失败不应阻止仓库删除（可能已被手动删除）
- 返回详细的错误信息给前端
- 记录删除的技能数量，便于调试

### 前端按钮合并设计

**修改 `RepositoriesPage.tsx` 的按钮渲染逻辑**：

**当前代码结构**（第 413-481 行）：
- 扫描按钮（始终显示）
- 刷新缓存按钮（`repo.cache_path` 存在时显示）
- 清理缓存按钮（`repo.cache_path` 存在时显示）

**新的按钮结构**：
1. **智能扫描按钮**：
   - 未缓存（`!repo.cache_path`）：
     - 显示文案："一键扫描"
     - 点击调用：`scanMutation.mutate(repo.id)`
     - 加载状态："扫描中..."
   - 已缓存（`repo.cache_path` 存在）：
     - 显示文案："重新扫描"
     - 点击调用：`refreshCacheMutation.mutate(repo.id)`
     - 加载状态："重新扫描中..."
   - 图标保持使用 `Search`（未缓存）或 `RefreshCw`（已缓存）

2. **删除按钮**：保持不变

**需要移除的代码**：
- `clearCacheMutation` 的定义和使用（第 57-66 行）
- `handleClearCache` 函数（第 148-150 行）
- 清理缓存按钮的 UI 代码（第 465-480 行）
- 相关的翻译 key：`repositories.cache.clear*`

**Hook 修改**：
- `useDeleteRepository` 的 `onSuccess` 回调中
- 添加 `queryClient.invalidateQueries({ queryKey: ["skills"] })`
- 确保删除仓库后技能列表也会刷新

## 数据流

### 删除仓库操作流

```
用户点击删除按钮
    ↓
deleteMutation.mutate(repo.id)
    ↓
后端 delete_repository 命令
    ↓
1. 查询仓库信息
2. 删除未安装技能（事务）
3. 清理缓存目录
4. 删除仓库记录（事务）
    ↓
返回成功/失败
    ↓
前端刷新 repositories 和 skills 查询
    ↓
UI 更新（仓库消失，未安装技能消失）
```

### 智能扫描操作流

```
用户点击智能扫描按钮
    ↓
判断是否已缓存（repo.cache_path）
    ↓
已缓存：refreshCacheMutation.mutate(repo.id)
未缓存：scanMutation.mutate(repo.id)
    ↓
后端处理（刷新缓存或扫描仓库）
    ↓
返回技能列表
    ↓
前端刷新：repositories、skills、cache-stats
    ↓
UI 更新（显示找到的技能数量）
```

## 测试验证步骤

### 功能测试

1. **测试删除仓库功能**：
   - 添加一个新仓库并扫描
   - 安装该仓库的某个技能
   - 删除该仓库
   - 验证：未安装的技能已从技能市场消失
   - 验证：已安装的技能仍在"我的技能"页面
   - 验证：缓存目录已被清理
   - 验证：仓库已从列表中消失

2. **测试智能扫描按钮**：
   - 添加新仓库（未缓存）
   - 验证：显示"一键扫描"按钮
   - 点击"一键扫描"
   - 验证：扫描成功，按钮变为"重新扫描"
   - 点击"重新扫描"
   - 验证：缓存刷新成功，技能列表更新

3. **测试错误处理**：
   - 删除不存在的仓库（应显示错误提示）
   - 删除缓存目录被占用的仓库（应成功删除仓库，警告缓存清理失败）

### 边界情况

1. 删除一个所有技能都已安装的仓库（不应删除任何技能）
2. 删除一个没有技能的仓库（应正常删除）
3. 删除一个没有缓存的仓库（应正常删除）
4. 同时快速点击多个仓库的删除按钮（应正确处理并发）

## 需要更新的翻译文件

### 中文翻译（`src/i18n/locales/zh.json`）

```json
{
  "repositories": {
    "scan": "一键扫描",
    "rescan": "重新扫描",
    "scanning": "扫描中...",
    "rescanning": "重新扫描中...",
    // 移除以下 key：
    // "cache.clear"
    // "cache.clearTooltip"
    // "cache.clearing"
    // "cache.cleared"
    // "cache.clearFailed"
  }
}
```

### 英文翻译（`src/i18n/locales/en.json`）

```json
{
  "repositories": {
    "scan": "Quick Scan",
    "rescan": "Rescan",
    "scanning": "Scanning...",
    "rescanning": "Rescanning...",
    // 移除相同的 cache.clear* keys
  }
}
```

## 风险和注意事项

### 风险

1. **数据丢失风险**：删除未安装技能是不可逆操作
   - 缓解：明确文档说明行为，保留已安装技能
   - 未来可考虑：添加删除确认对话框

2. **缓存清理失败**：权限或文件占用可能导致清理失败
   - 缓解：清理失败不阻止仓库删除，只记录警告

3. **数据库事务失败**：删除技能或仓库时可能失败
   - 缓解：使用事务确保原子性，失败时回滚

### 注意事项

1. 确保数据库事务正确实现，避免部分删除
2. 测试大量技能的删除性能
3. 确保前端正确刷新所有相关查询
4. 翻译文件需要同步更新中英文

## 后续优化建议

1. **删除确认对话框**：显示将被删除的未安装技能数量和已安装技能数量
2. **批量删除**：支持同时删除多个仓库
3. **软删除**：提供撤销删除功能（30天内可恢复）
4. **删除日志**：记录删除操作的详细日志，便于审计

## 总结

本设计通过后端统一处理删除逻辑，确保了数据一致性和操作原子性。同时通过合并按钮简化了用户界面，提升了用户体验。实施后，用户可以更安全、更直观地管理技能仓库。
